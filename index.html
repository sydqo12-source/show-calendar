<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" id="viewport-meta">
    <title>ê³µì—° ì˜ˆë§¤ì¼ì • (Mobile Only)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        /* [ê¸°ë³¸ ì„¤ì •] */
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #ffffff; 
            padding: 15px; 
            user-select: none; 
            -webkit-user-select: none; 
        }
        
        body.no-scroll { overflow: hidden; touch-action: none; }

        /* [í—¤ë”] */
        .header-wrapper { display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; }
        .main-title { font-size: 36px; font-weight: 800; color: #343a40; margin-bottom: 25px; word-break: keep-all; text-align: center; }
        .sub-title { font-size: 32px; font-weight: 800; color: #495057; }
        .nav-row { display: flex; align-items: center; gap: 8px; }
        
        .nav-btn {
            width: 30px; height: 30px; background-color: #fff; border: 1px solid #ced4da;
            border-radius: 4px; color: #868e96; font-size: 16px; font-weight: 700;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            transition: all 0.2s; user-select: none;
        }
        .nav-btn:hover { background-color: #f1f3f5; color: #343a40; border-color: #adb5bd; }
        .nav-btn.disabled { opacity: 0.3; pointer-events: none; }
        
        /* [ì»¨íŠ¸ë¡¤ ë°” (í•„í„°)] */
        .control-bar { 
            margin-bottom: 25px; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            gap: 12px; 
            padding-left: 0;
            font-size: 18px; 
        }
        
        .filter-group { display: flex; align-items: flex-start; gap: 4px; width: 100%; }
        .group-title { font-weight: 800; color: #212529; white-space: nowrap; font-size: 18px; margin-right: 4px; margin-top: 1px; }
        .chk-list { display: flex; flex-wrap: wrap; align-items: center; gap: 5px 4px; flex: 1; }
        
        label { cursor: pointer; display: flex; align-items: center; gap: 5px; margin-right: 5px; -webkit-tap-highlight-color: transparent; }
        label:hover { opacity: 1; } 
        input[type="checkbox"] { accent-color: #343a40; width: 18px; height: 18px; margin: 0; cursor: pointer; }
        
        .btn-reset {
            margin-left: 2px; background-color: transparent; border: 1px solid #adb5bd;
            border-radius: 4px; padding: 2px 8px; font-size: 15px; font-weight: 600;
            color: #495057; cursor: pointer; transition: all 0.2s; height: 28px;
            display: flex; align-items: center; -webkit-tap-highlight-color: transparent;
        }
        .btn-reset:hover { background-color: #e9ecef; color: #212529; }
        .btn-reset:active { background-color: transparent; color: #495057; border-color: #ced4da; }

        /* [í…ìŠ¤íŠ¸ ìƒ‰ìƒ] */
        .txt-red { color: #e03131; font-weight: 700; }
        .txt-green { color: #2b8a3e; font-weight: 700; }
        .txt-blue { color: #1971c2; font-weight: 700; }
        .txt-black { color: #495057; font-weight: 500; }

        /* ==========================================================================
           [ì¤‘ìš”] ë¦¬ìŠ¤íŠ¸í˜• ìº˜ë¦°ë” ìŠ¤íƒ€ì¼
           ========================================================================== */
        
        /* í…Œì´ë¸” ì „ì²´ ìŠ¤íƒ€ì¼ (ì¹´ë“œ í˜•íƒœ) */
        table { 
            display: block; 
            width: 100%; 
            background: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            border-radius: 12px; 
            overflow: hidden; 
            border: 1px solid #dee2e6; /* ì „ì²´ ì™¸ê³½ì„  */
            margin-bottom: 30px;
            border-collapse: separate; 
            border-spacing: 0; 
        }

        thead { display: none; }
        tbody, th, tr { display: block; }
        tr { margin-bottom: 0; }
        
        /* [ìˆ˜ì •] ë‚ ì§œ ì¹¸(td) ë””ìì¸ - í† ìš”ì¼ ë°‘ì¤„ ì‚´ë¦¬ê¸° */
        td { 
            display: block; 
            height: auto !important; 
            border: none; 
            border-bottom: 1px solid #e9ecef !important; /* ëª¨ë“  ì¹¸ì— ë°‘ì¤„ ì ìš© */
            position: relative; 
            text-align: left !important; 
            padding: 10px 15px !important; 
        }
        
        /* td:last-child { border-bottom: none !important; }  <-- ì´ ì¤„ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤ (í† ìš”ì¼ ë°‘ì¤„ ë³µêµ¬) */
        td:empty { display: none; } 

        /* ë‚ ì§œ ìˆ«ì ìŠ¤íƒ€ì¼ */
        .date-num { 
            display: inline-block; width: auto; font-size: 16px; 
            margin-bottom: 0; border-bottom: none; font-weight: 500; color: #ced4da; 
        }
        .date-num::after { content: "(" attr(data-dayname) ")"; font-size: inherit; color: inherit; font-weight: inherit; margin-left: 0; }
        .sun .date-num { color: #ffc9c9; } 
        .sat .date-num { color: #a5d8ff; }

        /* [ìƒíƒœë³„ ìŠ¤íƒ€ì¼] */
        
        /* 1. ê³µì—° ìˆëŠ” ë‚  (Active) */
        td.day-active {
            padding: 7px 7px 0px 7px !important; 
        }
        td.day-active .date-num { 
            font-size: 24px; margin-bottom: 7px; padding-bottom: 2px; color: #212529; font-weight: 800; 
        }
        td.day-active.sun .date-num { color: #e03131 !important; } 
        td.day-active.sat .date-num { color: #1971c2 !important; }

        /* 2. ê³µì—° ì—†ëŠ” ë‚  (Inactive) */
        td.day-inactive {
            padding: 7px 7px !important;
        }
        td.day-inactive .date-num { font-size: 16px; color: #ced4da; }
        td.day-inactive.sun .date-num { color: #ffc9c9; }
        td.day-inactive.sat .date-num { color: #a5d8ff; }

        /* [ê³µì—° ë°•ìŠ¤ ë””ìì¸] */
        .event-box { 
            display: none; 
            font-size: 16px !important; 
            padding: 7px; 
            margin-bottom: 7px; 
            border-radius: 10px;
            background-color: #fff; 
            border: 1px solid #ced4da; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer; 
            overflow: hidden; 
            transition: transform 0.2s, box-shadow 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .event-box:last-child {
            margin-bottom: 7;
        }
        
        .event-box:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 12px rgba(0,0,0,0.1); 
            border-color: #adb5bd; 
        }

        /* í¬ìŠ¤í„° ì´ë¯¸ì§€ ë¹„ìœ¨ ì›ë³¸ ìœ ì§€ */
        .event-poster-thumb {
            width: 100%;
            height: auto; 
            border-radius: 6px;
            margin-bottom: 12px;
            display: block;
            background-color: #f1f3f5;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
            user-select: none;
            pointer-events: auto;
        }

        .event-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 6px; font-size: 18px;
        }
        
        .box-line2 { 
            display: block;
            line-height: 1.4; 
            margin-top: 8px; 
            white-space: normal; 
            word-break: keep-all; 
        }

        /* ì´ˆê¸° ë¡œë”© ì‹œ ìŠ¤íƒ€ì¼ */
        body.initial-mode td { border-bottom: 1px solid #e9ecef !important; }
        body.initial-mode .date-num { font-size: 16px; font-weight: 500; color: #ced4da; }
        body.initial-mode .sun .date-num { color: #ffc9c9; }
        body.initial-mode .sat .date-num { color: #a5d8ff; }

        /* [íŒì—…(ëª¨ë‹¬) ìŠ¤íƒ€ì¼] */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.3); z-index: 9999;
            justify-content: center; align-items: center; padding-top: 0; 
            padding-bottom: 0; backdrop-filter: blur(0px); overflow-y: auto; 
        }
        .modal-content {
            background: white; width: 90%; max-width: 350px;
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: popUp 0.2s ease-out; margin-bottom: 0; 
        }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-poster-area {
            width: 100%; height: 400px; background-color: #f8f9fa;
            display: none !important; justify-content: center; align-items: center;
            overflow: hidden; border-bottom: 1px solid #eee;
        }
        .modal-poster-area img { 
            width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; 
            -webkit-touch-callout: none;
        }
        .no-poster-text { color: #adb5bd; font-weight: 600; font-size: 14px; }

        .modal-body { padding: 15px; text-align: center; }
        .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 5px; color: #212529; word-break: keep-all; }
        .modal-info { font-size: 16px; color: #868e96; margin-bottom: 15px; }

        .modal-btn-container { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .btn-row { display: flex; width: 100%; gap: 8px; }
        
        .modal-btn {
            padding: 0; height: 45px; border-radius: 8px; font-size: 18px; font-weight: 700;
            text-align: center; cursor: pointer; text-decoration: none; border: none;
            display: flex; justify-content: center; align-items: center; 
            transition: opacity 0.2s; -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important; user-select: none !important;
        }
        .modal-btn:hover { opacity: 0.9; }
        .btn-link-black { background-color: #343a40; color: white; flex: 1; } 
        .btn-action-red { background-color: #fa5252; color: white; flex: 1; }
        .btn-youtube-custom {
            background-color: white; color: black; border: 1px solid #ced4da;
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-youtube-custom:hover { background-color:#f8f9fa; }
        .yt-icon { width: 28px; height: auto; display: block; }

        /* [í™•ì¸ì°½ ë° ì´ë¯¸ì§€ í™•ëŒ€] */
        .confirm-content {
            background: white; width: 85%; max-width: 320px;
            border-radius: 12px; padding: 20px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: popUp 0.2s ease-out; margin: 0;
        }
        .confirm-text { font-size: 18px; font-weight: 700; color: #343a40; margin-bottom: 25px; line-height: 1.6; word-break: keep-all; }
        .confirm-btn-group { display: flex; gap: 10px; justify-content: center; }
        .confirm-btn { flex: 1; padding: 12px 0; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; border: none; }
        .btn-yes { background-color: #343a40; color: white; }
        .btn-no { background-color: #f1f3f5; color: #495057; }

        #imageZoomOverlay {
            display: none; position: fixed; z-index: 10001; 
            padding-top: 20px; left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; background-color: rgba(0,0,0,0.9);
            touch-action: pan-x pan-y pinch-zoom;
        }
        #zoomedImage {
            margin: auto; display: block; max-width: 95%; max-height: 90vh; 
            object-fit: contain; animation: zoomAnim 0.3s;
            -webkit-touch-callout: none;
        }
        @keyframes zoomAnim { from {transform:scale(0.8); opacity:0;} to {transform:scale(1); opacity:1;} }
        .close-zoom {
            position: absolute; top: 20px; right: 30px; 
            color: #f1f1f1; font-size: 40px; font-weight: bold; 
            transition: 0.3s; cursor: pointer; z-index: 10002;
        }
        .close-zoom:hover, .close-zoom:focus { color: #bbb; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body class="initial-mode">
    <div class="header-wrapper">
        <div class="main-title">ğŸ“Œê³µì—° ì˜ˆë§¤ì¼ì • ìº˜ë¦°ë”</div>
        <div class="nav-row">
            <div class="nav-btn" id="prev-btn">&lt;</div>
            <div class="sub-title" id="calendar-title">Loading...</div>
            <div class="nav-btn" id="next-btn">&gt;</div>
        </div>
    </div>
    
    <div class="control-bar">
        <div class="filter-group">
            <span class="group-title">ì§€ì—­ :</span>
            <div class="chk-list">
                <label><input type="checkbox" class="region-chk" value="ì„œìš¸"> <span class="txt-red">ì„œìš¸</span></label>
                <label><input type="checkbox" class="region-chk" value="ê²½ê¸°"> <span class="txt-red">ê²½ê¸°/ì¸ì²œ</span></label>
                <label><input type="checkbox" class="region-chk" value="ê·¸ ì™¸"> <span class="txt-blue">ê·¸ ì™¸ ì§€ì—­</span></label>
            </div>
        </div>
        
        <div class="filter-group">
            <span class="group-title">ì¥ë¥´ :</span>
            <div class="chk-list">
                <label><input type="checkbox" class="genre-chk" value="ì½˜ì„œíŠ¸" checked> <span class="txt-black">ì½˜ì„œíŠ¸</span></label> 
                <label><input type="checkbox" class="genre-chk" value="ë®¤ì§€ì»¬" checked> <span class="txt-black">ë®¤ì§€ì»¬</span></label> 
                <label><input type="checkbox" class="genre-chk" value="ì—°ê·¹" checked> <span class="txt-black">ì—°ê·¹</span></label> 
                <label><input type="checkbox" class="genre-chk" value="í´ë˜ì‹" checked> <span class="txt-black">í´ë˜ì‹</span></label> 
                <label><input type="checkbox" class="genre-chk" value="í–‰ì‚¬(ì „ì‹œ)" checked> <span class="txt-black">í–‰ì‚¬(ì „ì‹œ)</span></label> 
                <label><input type="checkbox" class="genre-chk" value="ê°€ì¡±" checked> <span class="txt-black">ê°€ì¡±</span></label>
                <button id="btn-reset" class="btn-reset">ëª¨ë‘í•´ì œ</button>
            </div>
        </div>
    </div>

    <div id="calendar-container">
            <div id="page-0" class="calendar-page" data-title="2026ë…„ 1ì›”" style="display: block;">
                <table>
                    <thead><tr><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr></thead>
                    <tbody>
                        <tr><td class='sun'></td><td></td><td></td><td></td><td><span class='date-num' data-dayname='ëª©'>1</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>2</span></td><td class='sat'><span class='date-num' data-dayname='í† '>3</span></td></tr>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>4</span></td><td><span class='date-num' data-dayname='ì›”'>5</span></td><td><span class='date-num' data-dayname='í™”'>6</span></td><td><span class='date-num' data-dayname='ìˆ˜'>7</span></td><td><span class='date-num' data-dayname='ëª©'>8</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>9</span></td><td class='sat'><span class='date-num' data-dayname='í† '>10</span></td></tr>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>11</span></td><td><span class='date-num' data-dayname='ì›”'>12</span></td><td><span class='date-num' data-dayname='í™”'>13</span></td><td><span class='date-num' data-dayname='ìˆ˜'>14</span></td><td><span class='date-num' data-dayname='ëª©'>15</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>16</span></td><td class='sat'><span class='date-num' data-dayname='í† '>17</span></td></tr>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>18</span></td><td><span class='date-num' data-dayname='ì›”'>19</span></td><td><span class='date-num' data-dayname='í™”'>20</span></td><td><span class='date-num' data-dayname='ìˆ˜'>21</span></td><td><span class='date-num' data-dayname='ëª©'>22</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>23</span></td><td class='sat'><span class='date-num' data-dayname='í† '>24</span></td></tr>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>25</span></td><td><span class='date-num' data-dayname='ì›”'>26</span></td><td><span class='date-num' data-dayname='í™”'>27</span></td><td><span class='date-num' data-dayname='ìˆ˜'>28</span></td><td><span class='date-num' data-dayname='ëª©'>29</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>30</span></td><td class='sat'><span class='date-num' data-dayname='í† '>31</span></td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="page-1" class="calendar-page" data-title="2026ë…„ 2ì›”" style="display: none;">
                <table>
                    <thead><tr><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr></thead>
                    <tbody>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>1</span></td><td><span class='date-num' data-dayname='ì›”'>2</span></td><td><span class='date-num' data-dayname='í™”'>3</span></td><td><span class='date-num' data-dayname='ìˆ˜'>4</span></td><td><span class='date-num' data-dayname='ëª©'>5</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>6</span></td><td class='sat'><span class='date-num' data-dayname='í† '>7</span></td></tr>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>8</span></td><td><span class='date-num' data-dayname='ì›”'>9</span></td><td><span class='date-num' data-dayname='í™”'>10</span></td><td><span class='date-num' data-dayname='ìˆ˜'>11</span></td><td><span class='date-num' data-dayname='ëª©'>12</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>13</span></td><td class='sat'><span class='date-num' data-dayname='í† '>14</span></td></tr>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>15</span></td><td><span class='date-num' data-dayname='ì›”'>16</span></td><td><span class='date-num' data-dayname='í™”'>17</span></td><td><span class='date-num' data-dayname='ìˆ˜'>18</span></td><td><span class='date-num' data-dayname='ëª©'>19</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>20</span></td><td class='sat'><span class='date-num' data-dayname='í† '>21</span></td></tr>
                        <tr><td class='sun'><span class='date-num' data-dayname='ì¼'>22</span></td><td><span class='date-num' data-dayname='ì›”'>23</span></td><td><span class='date-num' data-dayname='í™”'>24</span></td><td><span class='date-num' data-dayname='ìˆ˜'>25</span></td><td><span class='date-num' data-dayname='ëª©'>26</span></td><td><span class='date-num' data-dayname='ê¸ˆ'>27</span></td><td class='sat'><span class='date-num' data-dayname='í† '>28</span></td></tr>
                    </tbody>
                </table>
            </div>
    </div>

    <div id="eventModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-poster-area">
                <img id="modalPoster" src="" alt="ê³µì—° í¬ìŠ¤í„°" style="display:none;" oncontextmenu="return false;">
                <span id="noPosterText" class="no-poster-text" style="display:none;">ì´ë¯¸ì§€ ì—†ìŒ</span>
            </div>
            <div class="modal-body">
                <div id="modalTitle" class="modal-title"></div>
                <div id="modalInfo" class="modal-info"></div>
                <div class="modal-btn-container" id="btnGroup"></div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay" style="z-index: 10000; align-items: center; padding-top: 0;" onclick="closeConfirmModal(event)">
        <div class="confirm-content" onclick="event.stopPropagation()">
            <div class="confirm-text">
                ë‹¤ìš´ë¡œë“œ ë˜ëŠ” ics íŒŒì¼ì„ ì—´ë©´<br>ìº˜ë¦°ë” ì•±ì— ì¼ì • ì¶”ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </div>
            <div class="confirm-btn-group">
                <button onclick="realDownload()" class="confirm-btn btn-yes">í™•ì¸</button>
                <button onclick="closeConfirmModal()" class="confirm-btn btn-no">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="imageZoomOverlay" onclick="closeZoomOverlay()">
        <span class="close-zoom" onclick="closeZoomOverlay()">&times;</span>
        <img id="zoomedImage" src="" oncontextmenu="return false;">
    </div>

    <script>
        const SUPABASE_URL = 'https://btvwssnlrwvzgqdbcuti.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0dndzc25scnd2emdxZGJjdXRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjczMDIsImV4cCI6MjA4MzEwMzMwMn0.NF-nG9Dtwe__p5Xmzz4dmFT56B4XN77oBJlJxnPnDdM'; // ì—¬ê¸°ì— anon key ì…ë ¥
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let events = [];

        async function fetchEvents() {
            titleEl.innerText = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            
            const { data, error } = await client.from('events').select('*');
            
            if (error) {
                console.error('Error:', error);
                titleEl.innerText = "ë¡œë”© ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)";
                alert("Supabase ì—°ê²° ì˜¤ë¥˜: í‚¤ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
                return;
            }
            
            events = data;
            
            events.sort((a, b) => {
                const getTime = (str) => {
                    const match = str.match(/\d{2}:\d{2}/);
                    return match ? match[0] : '99:99';
                };

                const timeA = getTime(a.date);
                const timeB = getTime(b.date);

                if (timeA < timeB) return -1;
                if (timeA > timeB) return 1;

                if (a.title < b.title) return -1;
                if (a.title > b.title) return 1;

                return 0;
            });
            
            console.log("Supabase ë°ì´í„°:", events);
            
            renderEvents();
            showPage(0); 
        }

        const regionChks = document.querySelectorAll('.region-chk');
        const genreChks = document.querySelectorAll('.genre-chk');
        const btnReset = document.getElementById('btn-reset');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const titleEl = document.getElementById('calendar-title');
        
        const pages = document.querySelectorAll('.calendar-page');
        let currentIndex = 0;
        const totalPages = pages.length;

        const modal = document.getElementById('eventModal');
        const confirmModal = document.getElementById('confirmModal'); 
        const modalPoster = document.getElementById('modalPoster');
        const noPosterText = document.getElementById('noPosterText');
        const modalTitle = document.getElementById('modalTitle');
        const modalInfo = document.getElementById('modalInfo');
        const btnGroup = document.getElementById('btnGroup'); 
        
        let currentEventData = {}; 
        let isModalOpen = false; 

        function renderEvents() {
            document.querySelectorAll('.event-box').forEach(el => el.remove());
            document.querySelectorAll('td').forEach(td => {
                td.classList.remove('has-event');
                td.classList.add('no-event'); 
            });

            events.forEach(evt => {
                const nums = evt.date.match(/\d+/g); 
                if (!nums || nums.length < 2) return;

                const month = parseInt(nums[0], 10);
                const day = parseInt(nums[1], 10);
                const pageIndex = month - 1; 
                const targetPage = document.getElementById(`page-${pageIndex}`);
                if (!targetPage) return;

                const dateSpans = targetPage.querySelectorAll('.date-num');
                let targetTd = null;
                for (let span of dateSpans) {
                    if (parseInt(span.innerText, 10) === day) {
                        targetTd = span.parentElement;
                        break;
                    }
                }

                if (targetTd) {
                    const div = document.createElement('div');
                    div.className = 'event-box';
                    
                    let regionGroup = 'ê·¸ ì™¸'; 
                    if (evt.region === 'ì„œìš¸') regionGroup = 'ì„œìš¸';
                    else if (evt.region === 'ê²½ê¸°' || evt.region === 'ì¸ì²œ') regionGroup = 'ê²½ê¸°';
                    
                    div.dataset.regionGroup = regionGroup; 
                    div.dataset.region = evt.region; 
                    div.dataset.genre = evt.genre;
                    div.dataset.title = evt.title;
                    div.dataset.date = evt.date;
                    div.dataset.place = evt.place;
                    div.dataset.poster = evt.poster;
                    div.dataset.link1 = evt.link1 || '';
                    div.dataset.link2 = evt.link2 || '';
                    div.dataset.link3 = evt.link3 || '';
                    div.dataset.link4 = evt.link4 || '';
                    div.dataset.link5 = evt.link5 || '';
                    div.dataset.youtube = evt['youtube search'] || '';

                    div.onclick = function() { openModal(this); };

                    const timeStr = evt.date.split(' ')[1] || '';
                    let rClass = 'txt-blue';
                    if (['ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ'].includes(evt.region)) rClass = 'txt-red';
                    const rText = `(${evt.region})`;

                    let posterHtml = '';
                    if (evt.poster && evt.poster.trim() !== '') {
                        // [ìˆ˜ì •] ì´ë¯¸ì§€ ìš°í´ë¦­/ê¸¸ê²Œëˆ„ë¥´ê¸° ë°©ì§€ (oncontextmenu)
                        posterHtml = `<img src="${evt.poster}" class="event-poster-thumb" alt="${evt.title}" loading="lazy" oncontextmenu="return false;">`;
                    }
                    
                    const htmlContent = `
                        ${posterHtml}
                        <div class="event-header">
                            <div><span style="color:#212529; font-weight:800;">${timeStr}</span></div>
                            <div><span class="${rClass}">${rText}</span></div>
                        </div>
                        <span class="box-line2"><span style="color:#495057; font-weight:700; font-size: 18px;">${evt.title}</span></span>
                    `;
                    div.innerHTML = htmlContent;

                    targetTd.appendChild(div);
                    targetTd.classList.add('has-event');
                    targetTd.classList.remove('no-event');
                }
            });
            applyFilter();
        }

        function openModal(element) {
            const ds = element.dataset;
            currentEventData = {
                title: ds.title,
                date: ds.date,
                place: ds.place
            };

            modalTitle.innerText = ds.title;
            modalInfo.innerText = ds.place; 
            
            if (ds.poster && ds.poster.trim() !== '') {
                modalPoster.src = ds.poster;
                modalPoster.style.display = 'block';
                noPosterText.style.display = 'none';
                
                modalPoster.onclick = function() {
                    openZoomOverlay(ds.poster);
                };
            } else {
                modalPoster.style.display = 'none';
                noPosterText.style.display = 'block';
                modalPoster.onclick = null;
            }

            let htmlContent = '';

            const links = [];
            if(ds.link1) links.push({name: 'NOL í‹°ì¼“', url: ds.link1});
            if(ds.link2) links.push({name: 'yes24 í‹°ì¼“', url: ds.link2});
            if(ds.link3) links.push({name: 'ë©œë¡  í‹°ì¼“', url: ds.link3});
            if(ds.link4) links.push({name: 'í‹°ì¼“ë§í¬', url: ds.link4});
            if(ds.link5) links.push({name: 'ì˜ˆë§¤ì²˜', url: ds.link5});

            if (links.length > 0) {
                htmlContent += `<div class="btn-row">`;
                links.forEach(link => {
                    htmlContent += `<a href="${link.url}" target="_blank" class="modal-btn btn-link-black" oncontextmenu="return false">${link.name}</a>`;
                });
                htmlContent += `</div>`;
            }

            htmlContent += `<div class="btn-row">`;
            htmlContent += `<button onclick="openConfirmModal()" class="modal-btn btn-action-red" oncontextmenu="return false">ì˜ˆë§¤ì¼ì • ì¶”ê°€</button>`;
            
            if (ds.youtube && ds.youtube.trim() !== '') {
                const ytUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(ds.youtube)}`;
                htmlContent += `
                    <a href="${ytUrl}" target="_blank" class="modal-btn btn-youtube-custom" oncontextmenu="return false">
                        <img src="yt.png" alt="Youtube" class="yt-icon">
                        ìœ íŠœë¸Œ ê²€ìƒ‰
                    </a>`;
            }
            htmlContent += `</div>`;

            btnGroup.innerHTML = htmlContent;

            modal.style.display = 'flex';
            document.body.classList.add('no-scroll');
            
            history.pushState({view: 'modal'}, '', '#modal');
        }

        function openConfirmModal() {
            confirmModal.style.display = 'flex';
            history.pushState({view: 'confirm'}, '', '#confirm');
        }

        window.onpopstate = function(event) {
            const zoomOverlay = document.getElementById('imageZoomOverlay');
            if (zoomOverlay.style.display === 'block') {
                closeZoomOverlay();
                return;
            }

            if (event.state && event.state.view === 'modal') {
                confirmModal.style.display = 'none';
                modal.style.display = 'flex';
            } 
            else {
                confirmModal.style.display = 'none';
                modal.style.display = 'none';
                document.body.classList.remove('no-scroll');
            }
        };

        function closeConfirmModal() {
            if (confirmModal.style.display === 'flex') {
                history.back();
            }
        }

        function closeModal(e) {
            if (modal.style.display === 'flex') {
                history.back();
            }
        }

        function openZoomOverlay(imgSrc) {
            const overlay = document.getElementById('imageZoomOverlay');
            const zoomedImg = document.getElementById('zoomedImage');
            zoomedImg.src = imgSrc;
            overlay.style.display = 'block';
            document.body.classList.remove('no-scroll');
            const viewport = document.getElementById('viewport-meta');
            if(viewport) viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
        }

        function closeZoomOverlay() {
            const overlay = document.getElementById('imageZoomOverlay');
            overlay.style.display = 'none';
            if (modal.style.display === 'flex') document.body.classList.add('no-scroll');
            const viewport = document.getElementById('viewport-meta');
            if(viewport) viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        }

        function realDownload() {
            history.back(); 
            const title = (currentEventData.title || "ê³µì—° ê´€ëŒ") + " ì˜ˆë§¤";
            const rawDate = currentEventData.date;
            const nums = rawDate.match(/\d+/g); 
            
            let year = 2026; let month = '01'; let day = '01'; let hour = '12'; let min = '00';

            if (nums) {
                if (nums[0].length === 4) { 
                    year = nums[0]; month = nums[1]; day = nums[2];
                    if(nums.length >= 5) { hour = nums[3]; min = nums[4]; }
                } else { 
                    month = nums[0]; day = nums[1];
                    if(nums.length >= 4) { hour = nums[2]; min = nums[3]; }
                }
            }
            
            const pad = (n) => n.toString().padStart(2, '0');
            const startStr = `${year}${pad(month)}${pad(day)}T${pad(hour)}${pad(min)}00`;
            const endStr = `${year}${pad(month)}${pad(day)}T${pad(parseInt(hour)+2)}${pad(min)}00`; 

            const icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Show Calendar//KR
BEGIN:VEVENT
SUMMARY:${title}
DTSTART:${startStr}
DTEND:${endStr}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const linkElem = document.createElement('a');
            linkElem.href = window.URL.createObjectURL(blob);
            linkElem.setAttribute('download', `${title}.ics`);
            document.body.appendChild(linkElem);
            linkElem.click();
            document.body.removeChild(linkElem);
        }

        function showPage(index) {
            pages.forEach((page, idx) => {
                if (idx === index) {
                    page.style.display = 'block';
                    titleEl.innerText = page.dataset.title;
                } else {
                    page.style.display = 'none';
                }
            });
            
            if (index === 0) prevBtn.classList.add('disabled');
            else prevBtn.classList.remove('disabled');

            if (index === totalPages - 1) nextBtn.classList.add('disabled');
            else nextBtn.classList.remove('disabled');

            applyFilter();
        }

        function applyFilter() {
            const selectedRegions = Array.from(regionChks).filter(c => c.checked).map(c => c.value);
            const selectedGenres = Array.from(genreChks).filter(c => c.checked).map(c => c.value);
            
            const visiblePage = pages[currentIndex];
            const tds = visiblePage.querySelectorAll('td');

            if (selectedRegions.length === 0) {
                document.body.classList.add('initial-mode');
                visiblePage.querySelectorAll('.event-box').forEach(el => el.style.display = 'none');
                tds.forEach(td => {
                    td.classList.remove('day-active');
                    td.classList.add('day-inactive');
                });
                return;
            } else {
                document.body.classList.remove('initial-mode');
            }

            tds.forEach(td => {
                const boxes = td.querySelectorAll('.event-box');
                let hasVisible = false;
                
                boxes.forEach(box => {
                    if (selectedRegions.includes(box.dataset.regionGroup) && selectedGenres.includes(box.dataset.genre)) {
                        box.style.display = 'block';
                        hasVisible = true;
                    } else {
                        box.style.display = 'none';
                    }
                });

                if (hasVisible) {
                    td.classList.add('day-active');
                    td.classList.remove('day-inactive');
                } else {
                    td.classList.remove('day-active');
                    td.classList.add('day-inactive');
                }
            });
        }

        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                showPage(currentIndex);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < totalPages - 1) {
                currentIndex++;
                showPage(currentIndex);
            }
        });

        let isAllChecked = true;
        btnReset.addEventListener('click', () => {
            if (isAllChecked) {
                genreChks.forEach(chk => chk.checked = false);
                btnReset.innerText = "ëª¨ë‘ì„ íƒ";
                isAllChecked = false;
            } else {
                genreChks.forEach(chk => chk.checked = true);
                btnReset.innerText = "ëª¨ë‘í•´ì œ";
                isAllChecked = true;
            }
            applyFilter();
        });

        regionChks.forEach(chk => chk.addEventListener('change', applyFilter));
        genreChks.forEach(chk => chk.addEventListener('change', applyFilter));

        regionChks.forEach(c => c.checked = false);
        genreChks.forEach(c => c.checked = true);
        isAllChecked = true;
        btnReset.innerText = "ëª¨ë‘í•´ì œ";

        fetchEvents();
        
    </script>
</body>
</html>