from selenium import webdriver

from selenium.webdriver.chrome.service import Service

from webdriver_manager.chrome import ChromeDriverManager

from selenium.webdriver.common.by import By

from selenium.webdriver.support.ui import WebDriverWait

from selenium.webdriver.support import expected_conditions as EC

import pandas as pd

import time

import re



options = webdriver.ChromeOptions()

options.add_argument('--disable-blink-features=AutomationControlled')

driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)



url = "https://tickets.interpark.com/contents/notice"

driver.get(url)



print("====== â³ ì‚¬ì´íŠ¸ ì ‘ì† ë° ë¡œë”© ëŒ€ê¸°... ======")

time.sleep(10)



try:

    # 1. 'ì˜¤í”ˆìˆœ' í•„í„° ì§€ì  ì°¾ê¸° ë° í™”ë©´ ì´ë™

    wait = WebDriverWait(driver, 20)

    filter_el = wait.until(EC.presence_of_element_located((By.XPATH, "//*[contains(text(), 'ì˜¤í”ˆìˆœ')]")))

    driver.execute_script("arguments[0].scrollIntoView();", filter_el)

    print("âœ… 'ì˜¤í”ˆìˆœ' í•„í„° ì§€ì  ë°œê²¬! ëª©ë¡ì´ ë¡œë”©ë  ë•Œê¹Œì§€ 5ì´ˆê°„ ëŒ€ê¸°í•©ë‹ˆë‹¤...")

    time.sleep(5) 



    ticket_list = []

    collected_titles = set()

    # ë‚ ì§œ íŒ¨í„´: 01.07(ìˆ˜) 16:00

    date_pattern = re.compile(r'(\d{2}\.\d{2}\(.\)\s\d{2}:\d{2})')



    print("====== ğŸ“œ í•œ ì¤„ì”©(5ê°œ ë‹¨ìœ„) ë‚´ë ¤ê°€ë©° í…ìŠ¤íŠ¸ë¥¼ í†µì§¸ë¡œ ë¶„ì„í•©ë‹ˆë‹¤... ======")



    for _ in range(20): # ì¶©ë¶„íˆ ë§ì´ ë‚´ë ¤ê°€ë„ë¡ 20ë²ˆ ë°˜ë³µ

        # í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ì„œ ë¶„ì„ (ìƒì ì´ë¦„ì— ì˜ì¡´ X)

        # í•„í„° ì•„ë˜ì˜ ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ íƒ€ê²ŸíŒ…í•˜ê±°ë‚˜ ì „ì²´ bodyë¥¼ ê¸ìŒ

        body_text = driver.find_element(By.TAG_NAME, "body").get_attribute("innerText")

        

        # ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤.

        parts = re.split(date_pattern, body_text)

        

        # parts[0]ì€ í•„ìš” ì—†ëŠ” ìœ—ë¶€ë¶„, ê·¸ ë’¤ë¡œ [ë‚ ì§œ, ë‚´ìš©, ë‚ ì§œ, ë‚´ìš©...] ë°˜ë³µ

        for i in range(1, len(parts), 2):

            open_date = parts[i].strip()

            content = parts[i+1].strip()

            

            # ë‚ ì§œ ë’¤ì— ì˜¤ëŠ” ì²« ë‘ ì¤„ì„ ì œëª©ê³¼ ì¥ì†Œë¡œ ì¸ì‹ (ì‚¬ìš©ì ì—‘ì…€ íŒ¨í„´)

            lines = [l.strip() for l in content.split('\n') if l.strip()]

            

            if len(lines) >= 2:

                title = lines[0]

                location = lines[1]

                

                # ë¶ˆí•„ìš”í•œ ë‹¨ì–´ë“¤ í•„í„°ë§

                if "ì¶”í›„ê³µì§€" in title or "ì¶”í›„ê³µì§€" in location: continue

                if "í‹°ì¼“" in title and "ì•ˆë‚´" in title: continue # ê³µì§€ê¸€ ì œëª©ì¸ ê²½ìš° íŒ¨ìŠ¤

                

                if title not in collected_titles and len(title) > 2:

                    print(f"âœ… ë°œê²¬: [{open_date}] {title[:20]}...")

                    ticket_list.append({

                        'ì˜¤í”ˆì¼ì‹œ': open_date,

                        'ì œëª©': title,

                        'ì¥ì†Œ': location

                    })

                    collected_titles.add(title)



        # ì¡°ê¸ˆì”© ì•„ë˜ë¡œ ì´ë™

        driver.execute_script("window.scrollBy(0, 500);")

        time.sleep(2)

        

        # ë°”ë‹¥ ì²´í¬ (ë” ì´ìƒ ì•ˆ ë‚´ë ¤ê°€ë©´ ì¤‘ë‹¨)

        current_pos = driver.execute_script("return window.pageYOffset;")

        if current_pos + driver.execute_script("return window.innerHeight;") >= driver.execute_script("return document.body.scrollHeight;"):

            print("====== ğŸ í˜ì´ì§€ ëì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ======")

            break



    # 2. ë°ì´í„° ì •ë ¬ ë° ì €ì¥

    if ticket_list:

        df = pd.DataFrame(ticket_list)

        # ë‚ ì§œìˆœ ì •ë ¬ (01.05 -> 01.06 -> 01.07...)

        df = df.sort_values(by='ì˜¤í”ˆì¼ì‹œ', ascending=True)

        df.to_csv('ê³µì—°ëª©ë¡_ì˜¤í”ˆì˜ˆì •.csv', index=False, encoding='utf-8-sig')

        print(f"\nğŸ‰ ìµœì¢… ì„±ê³µ! ì´ {len(ticket_list)}ê°œì˜ ì •ë³´ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.")

    else:

        print("\nğŸ˜¢ ì´ë²ˆì—ë„ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì°½ì—ì„œ ëª©ë¡ì´ ì‹¤ì œë¡œ ëœ¨ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")



except Exception as e:

    print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")

finally:

    driver.quit()